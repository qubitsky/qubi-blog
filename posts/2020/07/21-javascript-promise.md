---
title: "ç†è§£ JavaScript Promise"
date: 2020-02-28
tags:
  - javascript
keywords:
  - javascript
  - promise
---

åŸæ–‡æœ€åˆå†™åœ¨çŸ¥ä¹ï¼šhttps://zhuanlan.zhihu.com/p/26523836 

ä»Šå¤©è¿ç§»è¿‡æ¥ï¼Œå®¡è§†çš„åŒæ—¶åšäº›ä¿®æ”¹ã€‚ä¸‹é¢æ˜¯æ­£æ–‡ ãƒ¾(^â–½^ãƒ¾)

---

## å‰è¨€

æœ¬æ–‡ç›®æ ‡ï¼šä»ä¸€è„¸æ‡µé€¼ï¼Œåˆ°è®¤è¯†ã€æŒæ¡å¹¶ä½¿ç”¨ Promise â€¦â€¦

[ECMAScript 2015](http://www.ecma-international.org/ecma-262/6.0/) è§„èŒƒå‡ºæ¥ä¹‹åï¼ŒJs å®¶æ—ä¸°æ»¡äº†è®¸å¤šï¼Œç®­å¤´å‡½æ•°ã€ç±»å£°æ˜ã€è§£æ„èµ‹å€¼ç­‰æ–°ç‰¹æ€§å†’äº†å‡ºæ¥ï¼Œå…¶ä¸­**æœ€é‡è¦**çš„ï¼Œæˆ‘è®¤ä¸ºå½“å± Promise ï¼Œå®ƒä¼šåœ¨ä½ çš„å‰ç«¯ç”Ÿæ¶¯ä¸­å å¾ˆå¤§çš„ä»½é‡ã€‚ä¸å­¦ä¼šPromiseï¼Œæ€ä¹ˆèƒ½è¯´è‡ªå·±æ‡‚ ES6 äº†å‘¢ï¼Ÿ

é‚£ä¹ˆ Promise åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Ÿï¼åƒæˆ‘è¿™æ ·çš„JavaScriptå°èœï¼Œåˆæ¬¡çœ‹åˆ°ï¼Œç€å®ä¸€è„¸æ‡µé€¼ã€‚ğŸ˜³

å…ˆæ¥çœ‹ä¸€äº›å­¦ä¹ èµ„æ–™ï¼š

- [JavaScript Promiseï¼šç®€ä»‹](https://developers.google.com/web/fundamentals/primers/promises#whats-all-the-fuss-about)
- [Promise - Mozilla Developer Network](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)
- [Promise å¯¹è±¡ - ECMAScript 6å…¥é—¨](https://es6.ruanyifeng.com/#docs/promise)

å¦‚æœä¸Šé¢çš„èµ„æ–™ï¼Œä½ çœ‹è¿‡åè§‰å¾—äº‘é‡Œé›¾é‡Œï¼Œä¸ç”šæ˜ç™½ï¼Œé‚£ä¹ˆä¸å¦¨å†è¯•è¯•æˆ‘ä¸‹é¢ç»™å‡ºçš„æ€»ç»“

## æœ¬æ–‡å†…å®¹

æœ¬æ–‡ä»ä¸‹é¢å‡ ä¸ªé—®é¢˜å¼€å§‹ï¼Œé€æ­¥äº†è§£ Promise çš„**æ¦‚å¿µ**å’Œ**ç”¨æ³•**ï¼Œé‡ç‚¹æ˜¯æ¦‚å¿µå•¦ï¼Œç”¨æ³•ä»€ä¹ˆçš„ç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æ–™å‚è€ƒ

- Promise æ˜¯ä»€ä¹ˆï¼Ÿ
- æœ‰ä»€ä¹ˆç”¨ï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
- æ€ä¹ˆä½¿ç”¨ Promise?

ä¸Šé¢çš„é—®é¢˜å³ï¼šæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿæ€ä¹ˆç”¨ï¼Ÿ

æœ€åæ•´ç†ä¸€äº›ä¹ é¢˜ã€ç¤ºä¾‹ï¼Œä»¥åŠå‚è€ƒèµ„æ–™ã€‚

## æ˜¯ä»€ä¹ˆ

å½“æˆ‘ä»¬è°ˆåˆ°ã€çœ‹åˆ°æˆ–è€…æåˆ° Promise çš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°ã€å¼‚æ­¥ç¼–ç¨‹ã€æµç¨‹æ§åˆ¶è¿™äº›æœ¯è¯­ï¼Œé€šå¸¸ä¼šå†’å‡ºæ¥ï¼Œè¿˜æœ‰ï¼Œå–äº† Promise ï¼ˆæ‰¿è¯ºï¼‰è¿™æ ·çš„åå­—ï¼Œç©¶ç«Ÿæ˜¯ä½•å«ä¹‰ã€‚é¦–å…ˆéƒ½åˆ« care ï¼Œæ²¡é‚£ä¹ˆå¤æ‚ã€‚

Promise è¯´ç®€å•äº†å°±æ˜¯ä¸€ç§å†™ä»£ç çš„æ–¹å¼ï¼Œå¹¶ä¸”æ˜¯ç”¨æ¥ä¹¦å†™ JavaScript ç¨‹åºä¸­å¼‚æ­¥ä»»åŠ¡çš„æ–¹å¼ï¼Œå®ƒè¢«ç§°ä¸º**é“¾å¼è¯­æ³•**ã€‚åé¢ä¼šå†è§£é‡Šä¸€ä¸‹å¼‚æ­¥ä»»åŠ¡ã€‚

### åŸºæœ¬ç”¨æ³•

é¦–å…ˆçœ‹ä¸‹æœ€åŸºæœ¬çš„ç”¨æ³•ã€‚ç¬¬ä¸€æ®µè¦è®¤è¯†çš„ä»£ç å¦‚ä¸‹ï¼š

```javascript
const p = new Promise((resolve, reject) => {
  // åšäº›äº‹æƒ…
  // ...
  // ç„¶åç¨‹åºèµ°åˆ°æŸäº›æ¡ä»¶ä¸‹ resolve
  // èµ°åˆ°å¦ä¸€äº›äº›æ¡ä»¶ä¸‹ reject
  // è¿™é‡Œæˆ‘ç”¨ç®€å•çš„ if è¯­å¥è¡¨è¾¾ä¸‹ä¸Šé¢çš„æ„æ€

  if (/* æ˜¯ä½ çš„æ¡ä»¶ ğŸ˜ */) {
    resolve()
  } else {
    reject()
  }

  // over
})

p.then(() => {
  // å¦‚æœ p çš„çŠ¶æ€è¢« resolve äº†ï¼Œå°±è¿›å…¥è¿™é‡Œ
}, () => {
  // å¦‚æœ p çš„çŠ¶æ€è¢«rejectï¼Œå°±è¿›å…¥è¿™é‡Œ
})
```

### è§£é‡Šä¸€ä¸‹

- ç¬¬ä¸€è¡Œè°ƒç”¨äº† Promise æ„é€ å‡½æ•°ï¼Œç»“æœæ˜¯ä¼šå¾—åˆ°ä¸€ä¸ªå¯¹è±¡ p ã€‚
- ç¬¬äºŒæ®µæ˜¯è°ƒç”¨äº†å¯¹è±¡ p ä¸Šçš„å®ä¾‹æ–¹æ³• `.then`

#### 1. æ„é€ å®ä¾‹

Promise æ„é€ å‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå–åå«åš **executor** ï¼Œè¿™é‡Œä¼ å…¥çš„ executor ä¸ºï¼š

```javascript
(resolve, reject) => {
  // åšäº›äº‹æƒ…
  // ...
  // ç„¶åç¨‹åºèµ°åˆ°æŸäº›æ¡ä»¶ä¸‹ resolve
  // èµ°åˆ°å¦ä¸€äº›äº›æ¡ä»¶ä¸‹ reject
  // è¿™é‡Œæˆ‘ç”¨ç®€å•çš„ if è¯­å¥è¡¨è¾¾ä¸‹ä¸Šé¢çš„æ„æ€

  if (/* æ˜¯ä½ çš„æ¡ä»¶ ğŸ˜ */) {
    resolve()
  } else {
    reject()
  }

  // over
}
```

è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼Œæ„é€ å‡½æ•°ä¼š**ç«‹å³æ‰§è¡Œ** executorï¼Œæœ€åä¼šè¿”å›å®ä¾‹ p ã€‚

æ„é€ å‡½æ•°æ‰§è¡Œ executor æ—¶ï¼Œä¼šä¼ å…¥ä¸¤ä¸ªå‡½æ•° **resolve** å’Œ **reject** ã€‚

åœ¨ executor å†…éƒ¨ï¼Œå¦‚æœè°ƒç”¨ resolve ï¼Œä¼šå°† p çš„çŠ¶æ€å˜æˆ **fulfilled** ï¼Œæˆ–è€…è°ƒç”¨ reject ï¼Œä¼šå°† p çš„çŠ¶æ€å˜æˆ **rejected** ï¼Œé‚£ä¹ˆï¼Œåœ¨è°ƒç”¨ resolve æˆ– reject ä¹‹å‰ï¼Œp çš„çŠ¶æ€å°±è¢«ç§°ä¸º **pending** ã€‚

å‰é¢çš„ fulfilled å’Œ rejected åˆè¢«ç»Ÿç§°ä¸º **settled** çŠ¶æ€ã€‚

#### 2. è°ƒç”¨ .then

è°ƒç”¨ .then å¯ä»¥ä¸ºå®ä¾‹ p æ³¨å†Œä¸å‰é¢ä¸¤ç§çŠ¶æ€å¯¹åº”çš„å›è°ƒå‡½æ•°

å½“å®ä¾‹ p çš„çŠ¶æ€ä¸º fulfilled ï¼Œä¼šè§¦å‘ç¬¬ä¸€ä¸ªå‡½æ•°æ‰§è¡Œ

å½“å®ä¾‹ p çš„çŠ¶æ€ä¸º rejected ï¼Œåˆ™è§¦å‘ç¬¬äºŒä¸ªå‡½æ•°æ‰§è¡Œ

### æ€»ç»“ä¸€ä¸‹

ä¸Šé¢å°±æ˜¯ä½¿ç”¨ promise æœ€åŸºæœ¬çš„æ¨¡å¼ï¼Œå³æ„é€ å‡º promise å®ä¾‹ï¼Œç„¶åè°ƒç”¨ .then çš„ç¼–å†™ä»£ç æ–¹å¼ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼ï¼š

1. å°†å¼‚æ­¥è¿‡ç¨‹ï¼ˆæ”¾åˆ° exector å‡½æ•°å†…ï¼‰è½¬åŒ–æˆ promise å¯¹è±¡
2. promise å¯¹è±¡åŒ…å«3ç§çŠ¶æ€
3. è°ƒç”¨å®ä¾‹æ–¹æ³• .then èƒ½æ³¨å†ŒçŠ¶æ€çš„å›è°ƒ
4. settled çš„çŠ¶æ€èƒ½è§¦å‘å›è°ƒ

é‡‡ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç†ç¼–ç¨‹ä¸­çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå°±æ˜¯åœ¨ä½¿ç”¨ promise ï¼Œä¹Ÿæ˜¯ä½¿ç”¨å®ƒçš„ç›®çš„ã€‚

æ‰€ä»¥ promise å°±æ˜¯ä¸€ç§**å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼**ã€‚

## è§£å†³çš„é—®é¢˜

è¿™éœ€è¦ä» Js ä¸­çš„å¼‚æ­¥ä»»åŠ¡è¯´èµ·â€¦â€¦

### å¼‚æ­¥ä»»åŠ¡

setTimeout è°ƒç”¨å°±æ˜¯ Js ä¸­ä¸€ä¸ªå…¸å‹çš„å¼‚æ­¥ä»»åŠ¡ï¼š

```javascript
setTimeout(() => {
  // çˆ±å¹²å•¥å¹²å•¥
}, 1000)
```

Js ä¸­çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š**å‘èµ·**éƒ¨åˆ†ï¼Œå’Œ**åç»­**éƒ¨åˆ†ï¼Œå³é¦–å…ˆéœ€è¦å‘èµ·ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åç­‰åˆ°ä»»åŠ¡å®Œæˆæ‰èƒ½è§¦å‘åç»­éƒ¨åˆ†ã€‚

æ¯”å¦‚ï¼Œåœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œç»å¸¸è¦ä½¿ç”¨ AJAX å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡å™¨å“åº”åï¼Œå‰ç«¯æ‰è·å–åˆ°æ•°æ®ï¼Œç„¶åå¤„ç†æ•°æ®ç”¨äºç•Œé¢å±•ç¤ºã€‚è¿™ä¸€è¿‡ç¨‹å°±åˆ†æˆäº†**å‘èµ·è¯·æ±‚**ï¼Œå’Œ**å¤„ç†å“åº”**ä¸¤éƒ¨åˆ†ï¼Œä»£ç å†™å‡ºæ¥å°±æ˜¯ä¸‹é¢è¿™æ ·ï¼š

```javascript
getData((data) => {
  // å¤„ç† data
})
// ...å‘èµ·è¯­å¥åé¢çš„ä»£ç 
```

ä¸Šé¢çš„ `getData` ï¼Œå¯¹åº”åˆ°å®é™…é¡¹ç›®ä¸­ï¼Œé€šå¸¸å°±æ˜¯è‡ªå·±å°è£…å¥½çš„è¯·æ±‚æ–¹æ³•ï¼Œå†…éƒ¨ç”¨åˆ°çš„å¯èƒ½æ˜¯ jQuery ä¸­çš„ `$.ajax`ï¼Œä¹Ÿå¯èƒ½æ˜¯ç°ä»£æµè§ˆå™¨æä¾›çš„ `fetch` APIï¼Œæˆ–è€…å…¶ä»–ã€‚

æˆ‘ä»¬åº”è¯¥çŸ¥é“ï¼Œ`getData` è¯­å¥è¢«æ‰§è¡Œåï¼Œç´§æ¥ç€å°±ä¼šæ‰§è¡Œåé¢çš„ä»£ç ï¼Œå¹¶ä¸ä¼šç­‰å¾…ï¼Œä¹Ÿä¸å…³å¿ƒä»€ä¹ˆæ—¶å€™å¤„ç†è¯·æ±‚æ•°æ®çš„åç»­éƒ¨åˆ†ï¼ˆå¤„ç† data ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª `getData` è°ƒç”¨ï¼Œä¸ä¼š**é˜»å¡**åé¢ä»»åŠ¡çš„æ‰§è¡Œï¼Œæ‰€ä»¥å®ƒè¢«ç§°ä¸º**å¼‚æ­¥**çš„ä»»åŠ¡ã€‚


### å›è°ƒå‡½æ•°

å†æ¥çœ‹çœ‹å¼‚æ­¥ä»»åŠ¡çš„åç»­éƒ¨åˆ†â€¦â€¦

å‰é¢ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œéƒ½æ˜¯é‡‡ç”¨äº†**å›è°ƒå‡½æ•°**æ¥è¡¨è¾¾åç»­éƒ¨åˆ†ã€‚ promise ï¼Œåˆ™æ˜¯å¦ä¸€ç§è¡¨è¾¾æ–¹å¼ã€‚

æ—¢ç„¶æœ‰å›è°ƒå‡½æ•°ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ promiseï¼Ÿ

å½“ç„¶æ˜¯å› ä¸ºå›è°ƒå‡½æ•°æ–¹å¼ä¸å¥½äº†ï¼ä¸å¥½åˆ°è¢«äººç§°ä¸º**å›è°ƒåœ°ç‹±** (\*/Ï‰ï¼¼\*)

ä¹Ÿè®¸æœ‰äººå¹¶æœªè§‰å¾—å›è°ƒå‡½æ•°æ–¹å¼æœ‰ä»€ä¹ˆä¸å¥½ï¼Œç¡®å®ä¹Ÿä¸èƒ½å…¨ç›˜å¦å®šã€‚è¿™å°±å¥½æ¯”æ“ä½œç³»ç»Ÿæœ‰ windows ã€mac os å’Œ linux ï¼Œç„¶è€Œå¤§å¤šæ•°äººåªçŸ¥é“ windows ã€‚ä¹ æƒ¯äº†ä½¿ç”¨ windows ï¼Œå¹¶æœªå°è¯•è¿‡å…¶ä»–ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ç†è§£å¦å¤–ä¸¤ç§çš„å¥½å¤„ã€‚åˆ«äººéª‚ windows åƒåœ¾ï¼ŒæåŠ›æ¨èå…¶ä»–ç»™ä½ ï¼Œä½ ä¹Ÿå¯èƒ½ä¸æƒ³æ”¹å˜ä½¿ç”¨ä¹ æƒ¯â€¦â€¦

ç„¶è€Œç³»ç»Ÿå¯èƒ½åªæ˜¯è‡ªå·±ä½¿ç”¨ï¼Œä»£ç å†™å‡ºæ¥ï¼Œé€šå¸¸æ˜¯ä¼šç»™åˆ«äººçœ‹çš„ï¼Œå°¤å…¶æ˜¯å›¢é˜Ÿåä½œå¼€å‘ã€‚

#### å›è°ƒå“ªé‡Œä¸å¥½äº†ï¼Ÿ

ç°åœ¨çœ‹å¤æ‚ç‚¹çš„æƒ…å†µã€‚å‡è®¾æœ‰å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œä¸”ä»»åŠ¡é—´æœ‰å‰åä¾èµ–å…³ç³»ï¼ˆæ¯ä¸€ä¸ªä»»åŠ¡éƒ½ä¾èµ–å‰ä¸€ä¸ªä»»åŠ¡çš„ç»“æœï¼‰ï¼Œå›è°ƒæ–¹å¼å†™å‡ºæ¥çš„ä»£ç å°±ä¼šåƒä¸‹é¢è¿™æ ·ï¼š

```javascript
getData1(data1 => {
  getData2(data1, data2 => {
    getData3(data2, data3 => {
      getData4(data3, data4 => {
        getData5(data4, data5 => {
          // ç»ˆäºå–åˆ°data5äº†
        })
      })
    })
  })
})
```

è¿™ç§æ ¼å¼çš„å½¢çŠ¶ï¼Œæ˜¯ä¸æ˜¯å¾ˆåƒé‡‘å­—å¡”ï¼Ÿæ‰€ä»¥å®ƒè¢«ç§°ä½œ**å›è°ƒé‡‘å­—å¡”**ï¼Œä¹Ÿè¢«ç§°ä¸ºå›è°ƒåœ°ç‹±ã€‚

å†å‡è®¾ä¸Šé¢çš„ä»»åŠ¡æµç¨‹é‡Œï¼Œæƒ³è¦æ”¹ä¸€ä¸‹æ‰§è¡Œé¡ºåºï¼Ÿè¿™æ—¶å€™å°±ä¼šå‘ç°ï¼Œä»£ç æ”¹èµ·æ¥æ¯”è¾ƒéº»çƒ¦äº†ï¼Œéœ€è¦ä¸Šä¸‹ç§»åŠ¨åµŒå¥—å±‚çº§ã€‚è€Œä¸”ï¼Œå½“çœŸå®çš„ä¸šåŠ¡é€»è¾‘å¡«è¿›å»ï¼Œä»£ç å˜å¾—å¤æ‚ï¼Œé˜…è¯»èµ·æ¥è·³ä¸Šè·³ä¸‹ï¼Œä¼šè®©äººå¤´å¤§ã€‚

#### æ”¹å†™

å¦‚æœç”¨ promise æ”¹å†™ä¸€ä¸‹ï¼š

```javascript
// å‡è®¾å…ˆæŠŠ getData ä»¬éƒ½æ”¹æˆäº†è¿”å› promise å¯¹è±¡çš„å‡½æ•°

// ç„¶å
getData1()
.then(getData2)
.then(getData3)
.then(getData4)
.then(getData5)
.then(data => {
  // å–åˆ°æœ€ç»ˆdataäº†
})
```

è¿™æ ·çš„é“¾å¼é£æ ¼ä»£ç ï¼Œæ˜¯çº¿æ€§çš„ï¼Œç¬¦åˆäººä»¬çš„é˜…è¯»ä¹ æƒ¯ï¼Œè¡¨è¾¾å‡ºæ¥çš„æµç¨‹æ¸…æ™°ã€æ˜“è¯»ã€‚


### ä»»åŠ¡å¹¶è¡Œ

å‰é¢å±•ç¤ºçš„å¤šä¸ªå¼‚æ­¥ä»»åŠ¡å‰åä¾èµ–ï¼Œä¹Ÿå¯ç§°ä¸º**ä¸²è¡Œ**ã€‚å¦å¤–è¿˜æœ‰æƒ³è¦å¤šä¸ªå¼‚æ­¥ä»»åŠ¡**å¹¶è¡Œæ‰§è¡Œ**çš„æƒ…å†µï¼Œå³å¤šä¸ªä»»åŠ¡åŒæ—¶å‘èµ·ï¼Œç­‰åˆ°å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ç»Ÿä¸€å¤„ç†å…¨éƒ¨ç»“æœã€‚

ç”¨å›è°ƒæ–¹å¼æ¥å†™ï¼Œå¯é‡‡ç”¨ä¸‹é¢çš„åŠæ³•ï¼š

```javascript
const tasks = [getData1, getData2, getData3, getData4, getData5]
const datas = []

tasks.forEach(task => {
  task(data => {
    datas.push(data)

    if (datas.length === tasks.length) {
      // datas é‡Œæ‹¿åˆ°å…¨éƒ¨çš„æ•°æ®äº†ï¼Œå¼€å§‹ç»Ÿä¸€å¤„ç†
    }
  })
})
```

ä¸Šé¢ä½¿ç”¨äº†æ•°ç»„ï¼Œç»“åˆ forEach æ–¹æ³•æ¥ä¸ºæ¯ä¸ªä»»åŠ¡ä¼ å…¥å›è°ƒã€‚

å¦‚æœæ”¹ç”¨ promise æ¥å®ç°ï¼Œä»£ç ä¼šæ˜¯è¿™æ ·ï¼š

```javascript
// å‡è®¾å…ˆè¦æŠŠ getData ä»¬è½¬æˆäº† promise å¯¹è±¡

// ç„¶å
Promise.all([
  getData1,
  getData2,
  getData3,
  getData4,
  getData5
]).then(datas => {
  // åœ¨è¿™é‡Œç»Ÿä¸€å¤„ç†å…¨éƒ¨çš„æ•°æ®
})
```

å¯ä»¥çœ‹åˆ°ï¼Œpromise çš„é“¾å¼é£æ ¼ä»£ç æ›´ç®€æ´æ˜“è¯»

## å¦‚ä½•ä½¿ç”¨
 
æ—¢ç„¶ promise æ˜¯ä¸€ç§æ›´å¥½çš„ç¼–ç¨‹æ–¹å¼ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦å¥½å¥½äº†è§£ä¸‹å®ƒçš„å…·ä½“å†…å®¹å’Œä½œç”¨äº†ã€‚

å‰é¢å·²ç»æåˆ°ä¸€éƒ¨åˆ†å†…å®¹äº†ï¼Œåœ¨æœ¬å°èŠ‚é‡Œä¼šæ€»ç»“å®Œå–„ä¸€ä¸‹ï¼Œæ€ä¹ˆç”¨è¿˜å¾—çœ‹å®˜ä»¬è‡ªå·±å»å®è·µæ€»ç»“ã€‚

æ¥ä¸‹æ¥çš„å†…å®¹åŠ›æ±‚è¯¦ç»†ï¼Œå¯èƒ½ä¼šæœ‰äº›å•°å—¦ï¼Œå»ºè®®å¤§å®¶è‡ªè¡Œå†™ä»£ç éªŒè¯ä¼šå®¹æ˜“ç†è§£å¾—å¤š

### 3ç§çŠ¶æ€

é¦–å…ˆï¼Œpromise å®ä¾‹æœ‰ 3 ç§çŠ¶æ€ï¼š

- pendingï¼ˆå¾…å®šï¼‰
- fulfilledï¼ˆå·²æ‰§è¡Œï¼‰
- rejectedï¼ˆå·²æ‹’ç»ï¼‰

fulfilled å’Œ rejected ä¹Ÿå¯ä»¥è¯´æ˜¯å·²æˆåŠŸå’Œå·²å¤±è´¥ï¼Œç»Ÿç§°ä¸ºå·²å®Œæˆï¼ˆsettledï¼‰çŠ¶æ€

### resolve å’Œ reject

promise çš„åˆå§‹çŠ¶æ€æ˜¯ pending ï¼Œåœ¨ exector ï¼ˆå‰é¢æœ‰æåˆ°è¿‡ï¼‰å†…è°ƒç”¨ resolve æˆ– reject ï¼Œèƒ½å°† promise å®ä¾‹çš„çŠ¶æ€å¯¹åº”å˜æˆ fulfilled æˆ– rejected ï¼Œåªæœ‰å˜æˆè¿™ä¸¤ç§çŠ¶æ€ï¼Œæ‰èƒ½è§¦å‘ .then åçŠ¶æ€å¯¹åº”çš„å›è°ƒ

### Promise API

promise çš„æä¾›çš„ api åˆ†ä¸ºæ„é€ å‡½æ•°ã€å®ä¾‹æ–¹æ³•å’Œé™æ€æ–¹æ³•ï¼š

- 1ä¸ªæ„é€ å‡½æ•°ï¼š `new Promise`
- 2ä¸ªå®ä¾‹æ–¹æ³•ï¼š `.then` å’Œ `.catch`
- 4ä¸ªé™æ€æ–¹æ³•ï¼š `Promise.all` ã€ `Promise.race` ã€ `Promise.resolve` å’Œ `Promise.reject`

ä¸‹é¢å¤šè¯´å‡ å¥å®ƒä»¬çš„ä½œç”¨

#### æ„é€ å‡½æ•°

`new Promise` å¸¸ç”¨äºå°†ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œè¿å¸¦ç›¸å…³çš„é€»è¾‘ï¼Œæ”¹é€ æˆ promise å¯¹è±¡ã€‚å…ˆæœ‰äº† promise å¯¹è±¡ï¼Œç„¶åæ‰èƒ½å¤Ÿä»¥ promise çš„æ–¹å¼ç¼–ç¨‹ã€‚

æ¯”å¦‚ï¼š

```javascript
// æ”¹é€ å‰çš„ setTimeout
setTimeout(() => {
  console.log('3ç§’é’Ÿåˆ°äº†')
}, 3000)

// promise å¤§æ”¹é€ 
const promiseTimeout = delay => new Promise(resolve => {
  setTimeout(() => {
    resolve()
  }, delay)
})

// æ”¹é€ åçš„ promise ç‰ˆ setTimeout
promiseTimeout(3000)
  .then(() => {
    console.log('3ç§’é’Ÿåˆ°äº†')
  })
```

#### .then æ–¹æ³•

`.then` ç”¨äºä¸º promise å¯¹è±¡çš„çŠ¶æ€æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå®ƒè¿”å›çš„ä»ç„¶æ˜¯ä¸€ä¸ª promise å¯¹è±¡ï¼Œæ‰€ä»¥åé¢è¿˜å¯ä»¥è¿æ¥ `.then` ï¼Œåé¢è¿˜å¯ä»¥â€¦â€¦ï¼Œè¿™æ ·å°±å½¢æˆäº†**é“¾å¼è°ƒç”¨**ã€‚

`.then` å¯ä»¥æ³¨å†Œä¸¤ä¸ªçŠ¶æ€å›è°ƒå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå«åš onFulfilled , ç¬¬äºŒä¸ªå«åš onRejected ï¼Œå®ƒä»¬ä¸­çš„ `return` ä¼šå½±å“åˆ°ï¼Œè¯¥ `.then` è¿”å›çš„ promise å¯¹è±¡çš„çŠ¶æ€ï¼Œä»¥åŠçŠ¶æ€æºå¸¦çš„**æ•°æ®**ï¼Œæ•°æ®ä¼šä¼ é€’ç»™åé¢çš„ onFulfilled æˆ– onRejectedã€‚

`return` å¯ä»¥åˆ†ä¸ºä¸‹é¢å‡ ç§ï¼Œ onFulfilled å’Œ onRejected ä¸­çš„éƒ½ä¸€æ ·ï¼š

1. `return` ä¸€ä¸ªé promise æ•°æ®ï¼Œä¼šå°† `.then` è¿”å›çš„ promise çŠ¶æ€ resolve ï¼Œè¿”å›çš„ promise å°†è¯¥æ•°æ®å‘åä¼ é€’
2. æ²¡æœ‰ `return` è¯­å¥ï¼Œç­‰åŒäºæœ«å°¾ `return undefined` ï¼Œå½’ç»“ä¸ºæƒ…å½¢ 1 ã€‚
3. `return` ä¸€ä¸ª promise ï¼Œåé¢çš„ `.then` è¿”å›çš„ promise è¡Œä¸ºå°†å–å†³äºè¿™ä¸ª `return` çš„ promise

#### .catch æ–¹æ³•

`.catch` ä»…ç”¨äºä¸º rejected çŠ¶æ€æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œè¢«ç§°ä¸º onRejected ã€‚è¯¥å›è°ƒé€šå¸¸æ˜¯å¼‚å¸¸æƒ…å†µçš„å›è°ƒï¼Œå¯ä»¥æ˜¯è‡ªå·±è®¤ä¸ºçš„å¼‚å¸¸ï¼Œè¿˜åŒ…æ‹¬ç¨‹åºè¿è¡Œé”™è¯¯æƒ…å†µï¼Œå³å¦‚æœå‰é¢çš„ Js è¯­å¥è¿è¡Œä¸­å‡ºé”™ï¼Œå°±ä¼šè¿›å…¥è¯¥å›è°ƒï¼Œ`.then` ä¸­æ³¨å†Œçš„ onRejected å®Œå…¨ä¸€æ ·ã€‚è¿”å›åŒ.thenä¸€æ ·ï¼Œä¹Ÿæ˜¯æ–°çš„ promise å¯¹è±¡ã€‚

#### é“¾å¼è°ƒç”¨

å¯æ¦‚æ‹¬æˆ**å°±è¿‘åŸåˆ™**ï¼šå½“å‰é¢çš„ promise çŠ¶æ€ä¸º settled ï¼ˆè¢« resolve æˆ– reject ï¼‰åï¼Œä¼šè§¦å‘åé¢ç¦»å®ƒæœ€è¿‘çš„ onFulfilled æˆ– onRejected å›è°ƒã€‚

#### é™æ€æ–¹æ³•

å¦‚æœç†è§£äº†å‰é¢çš„æ¦‚å¿µï¼Œå‰©ä¸‹çš„ä¹Ÿå°±ä¸éš¾äº†ï¼Œè‡ªè¡Œå‚è€ƒå¯¹åº”çš„æ–‡æ¡£å³å¯ã€‚è¿™é‡Œåªåšç®€å•è¯´æ˜

- è°ƒç”¨ `Promise.resolve` ä¼šç«‹å³è¿”å›ä¸€ä¸ªçŠ¶æ€ä¸º fulfilled çš„ promise å¯¹è±¡ï¼Œå‚æ•°ä¼šä½œä¸ºæ•°æ®ï¼Œä¼ é€’ç»™åé¢çš„å¯¹åº”çš„çŠ¶æ€å›è°ƒ
- `Promise.reject` ä¸ `Promise.resolve` åŒç†ï¼ŒåŒºåˆ«åœ¨äºè¿”å›çš„ promise å¯¹è±¡çŠ¶æ€ä¸º rejected
- `Promise.all` åˆ™ç”¨æ¥å¹¶è¡Œå¤„ç†å¤šä¸ª promise ï¼Œå‰é¢å·²ç»æåˆ°è¿‡
- `Promise.race` ä¹Ÿæ˜¯ç”¨æ¥å¹¶è¡Œå¤„ç†å¤šä¸ª promise ï¼Œä¸ `Promise.all` çš„åŒºåˆ«åœ¨äºï¼Œå®ƒè¡¨ç¤ºæœ‰ä¸€ä¸ª promise çŠ¶æ€å˜æˆ settled äº†ï¼Œå°±è§¦å‘åç»­çŠ¶æ€å›è°ƒ

## æœªå®Œå¾…ç»­

ES7 ç»™å‡ºäº† promise çš„ä¸€äº›æ–°çš„ API â€¦â€¦

## æœ‰è¶£çš„ä¹ é¢˜

ç½‘ä¸Šæ‰¾åˆ°ä¸€ä¸ªæœ‰æ„æ€çš„ promise é¢è¯•é¢˜ï¼š[å®ç°çº¢ç»¿ç¯äº¤æ›¿äº®ç¯](https://www.cnblogs.com/dojo-lzz/p/5495671.html)

è´´ä¸€ä¸‹æˆ‘çš„è§£ç­”ï¼š

```javascript
// æ€è·¯ï¼šå…ˆç”¨promiseæ§åˆ¶ä¸‰ç§ç¯çš„æ‰§è¡Œé¡ºåºï¼Œç„¶åç”¨é€’å½’å®ç°å¾ªç¯äº®ç¯

const red = () => {
  console.log('red');
}

const green = () => {
  console.log('green');
}

const yellow = () => {
  console.log('yellow');
}

const light = (fn, timer) => new Promise(resolve => {
  setTimeout(() => {
    fn()
    resolve()
  }, timer)
})

// timesä¸ºäº¤æ›¿æ¬¡æ•°
const start = (times) => {
  if (!times) {
    return
  }

  times--
  Promise.resolve()
    .then(() => light(red, 3000))
    .then(() => light(green, 1000))
    .then(() => light(yellow, 2000))
    .then(() => start(times))
}

start(3)
```
